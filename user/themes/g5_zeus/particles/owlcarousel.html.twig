{% extends '@nucleus/partials/particle.html.twig' %}

{% block particle %}

    <div class="{{ particle.class|e }} custom-carousel-container">
        {% if particle.title %}<h2 class="g-title">{{ particle.title|raw }}</h2>{% endif %}

        <div id="g-custom-carousel-{{ id }}" class="custom-carousel-wrapper">
            <button class="custom-carousel-nav prev"><i class="fa fa-chevron-left" aria-hidden="true"></i></button>
            <div class="custom-carousel-track">
                {# Items will be injected here by JS #}
            </div>
            <button class="custom-carousel-nav next"><i class="fa fa-chevron-right" aria-hidden="true"></i></button>
        </div>
    </div>


{% endblock %}

{% block javascript_footer %}
    {# Lightbox HTML Structure (injected dynamically or here) #}
    {# We place it outside the main container to avoid overflow issues #}
    <div id="custom-lightbox" class="custom-lightbox">
        <button id="lightbox-close" class="lightbox-close">&times;</button>
        <img id="lightbox-img" class="lightbox-img" src="" alt="Full Screen User Image">
    </div>

    <script type="text/javascript">
        (function() {
            var carouselId = 'g-custom-carousel-{{ id }}';
            var wrapper = document.getElementById(carouselId);
            if (!wrapper) return;

            var track = wrapper.querySelector('.custom-carousel-track');
            var prevBtn = wrapper.querySelector('.prev');
            var nextBtn = wrapper.querySelector('.next');
            
            // Lightbox Elements
            var lightbox = document.getElementById('custom-lightbox');
            var lightboxImg = document.getElementById('lightbox-img');
            var lightboxClose = document.getElementById('lightbox-close');

            // Collect items data
            var items = [
                {% for item in particle.items %}
                    {% if not item.disable %}
                    {
                        image: "{{ url(item.image)|e('js') }}",
                        title: "{{ item.title|e('js') }}",
                        desc: "{{ item.desc|e('js') }}",
                        link: "{{ item.link|e('js') }}",
                        linktext: "{{ item.linktext|e('js') }}"
                    },
                    {% endif %}
                {% endfor %}
            ];

            if (items.length === 0) return;

            // Configuration
            // We always use 4 clones to support the desktop view.
            var CLONE_COUNT = 4;
            var totalItems = items.length;
            
            // Generate Clones
            var clonesBefore = items.slice(-CLONE_COUNT);
            var clonesAfter = items.slice(0, CLONE_COUNT);
            var allItems = clonesBefore.concat(items).concat(clonesAfter);
            
            // State
            var offsetIndex = CLONE_COUNT; 
            var isAnimating = false;
            
            // Dynamic State
            var currentVisibleItems = 4;
            var itemWidthPercent = 25; // 100 / 4

            // Helper to determine visible items based on width
            function getVisibleItems() {
                return window.innerWidth <= 768 ? 1 : 4;
            }

            // Render all items initially
            allItems.forEach(function(data) {
                var node = createItemNode(data);
                track.appendChild(node);
            });
            
            // Initial Layout
            updateLayout();

            function createItemNode(data) {
                var itemDiv = document.createElement('div');
                itemDiv.className = 'custom-carousel-item';
                
                var imgDiv = document.createElement('div');
                imgDiv.className = 'custom-carousel-img';
                imgDiv.style.backgroundImage = 'url(' + data.image + ')';
                
                var contentDiv = document.createElement('div');
                contentDiv.className = 'custom-carousel-content';
                
                if (data.title) {
                    var title = document.createElement('h3');
                    title.textContent = data.title;
                    contentDiv.appendChild(title);
                }
                
                itemDiv.appendChild(imgDiv);
                itemDiv.appendChild(contentDiv);
                
                // Add Click Listener for Lightbox
                itemDiv.addEventListener('click', function() {
                    openLightbox(data.image);
                });
                
                return itemDiv;
            }

            function updateLayout() {
                currentVisibleItems = getVisibleItems();
                itemWidthPercent = 100 / currentVisibleItems;
                
                // Update width of all items
                var children = track.children;
                for (var i = 0; i < children.length; i++) {
                    children[i].style.flex = '0 0 ' + itemWidthPercent + '%';
                    children[i].style.width = itemWidthPercent + '%';
                }
                
                // Update position without transition
                updateTransform(false);
            }

            function updateTransform(enableTransition) {
                if (enableTransition) {
                    track.style.transition = 'transform 0.5s ease';
                } else {
                    track.style.transition = 'none';
                }
                
                var percentTranslate = -(offsetIndex * itemWidthPercent);
                track.style.transform = 'translateX(' + percentTranslate + '%)';
            }

            function moveNext() {
                if (isAnimating) return;
                isAnimating = true;
                
                offsetIndex++;
                updateTransform(true);
                
                setTimeout(function() {
                    if (offsetIndex >= CLONE_COUNT + totalItems) {
                        offsetIndex = CLONE_COUNT;
                        updateTransform(false);
                    }
                    isAnimating = false;
                }, 500);
            }

            function movePrev() {
                if (isAnimating) return;
                isAnimating = true;
                
                offsetIndex--;
                updateTransform(true);
                
                setTimeout(function() {
                    if (offsetIndex < CLONE_COUNT) {
                        offsetIndex = offsetIndex + totalItems;
                        updateTransform(false);
                    }
                    isAnimating = false;
                }, 500);
            }

            nextBtn.addEventListener('click', moveNext);
            prevBtn.addEventListener('click', movePrev);
            
            // Resize listener
            var resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(function() {
                    updateLayout();
                }, 100);
            });

            // --- Lightbox Logic ---
            function openLightbox(src) {
                lightboxImg.src = src;
                lightbox.classList.add('active');
                document.body.style.overflow = 'hidden'; // Lock text scrolling
            }
            
            function closeLightbox() {
                lightbox.classList.remove('active');
                document.body.style.overflow = ''; // Restore scrolling
            }
            
            lightboxClose.addEventListener('click', closeLightbox);
            
            // Close on background click
            lightbox.addEventListener('click', function(e) {
                if (e.target === lightbox) {
                    closeLightbox();
                }
            });
            
            // Close on Escape key
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && lightbox.classList.contains('active')) {
                    closeLightbox();
                }
            });

        })();
    </script>
{% endblock %}
