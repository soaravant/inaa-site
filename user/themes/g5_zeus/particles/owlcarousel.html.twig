{% extends '@nucleus/partials/particle.html.twig' %}

{% block particle %}

    <div class="{{ particle.class|e }} custom-carousel-container">
        {% if particle.title %}<h2 class="g-title">{{ particle.title|raw }}</h2>{% endif %}

        <div id="g-custom-carousel-{{ id }}" class="custom-carousel-wrapper">
            <button class="custom-carousel-nav prev"><i class="fa fa-chevron-left" aria-hidden="true"></i></button>
            <div class="custom-carousel-track">
                {# Items will be injected here by JS #}
            </div>
            <button class="custom-carousel-nav next"><i class="fa fa-chevron-right" aria-hidden="true"></i></button>
        </div>
    </div>

{% endblock %}

{% block javascript_footer %}
    <script type="text/javascript">
        (function() {
            var carouselId = 'g-custom-carousel-{{ id }}';
            var wrapper = document.getElementById(carouselId);
            if (!wrapper) return;

            var track = wrapper.querySelector('.custom-carousel-track');
            var prevBtn = wrapper.querySelector('.prev');
            var nextBtn = wrapper.querySelector('.next');

            // Collect items data
            var items = [
                {% for item in particle.items %}
                    {% if not item.disable %}
                    {
                        image: "{{ url(item.image)|e('js') }}",
                        title: "{{ item.title|e('js') }}",
                        desc: "{{ item.desc|e('js') }}",
                        link: "{{ item.link|e('js') }}",
                        linktext: "{{ item.linktext|e('js') }}"
                    },
                    {% endif %}
                {% endfor %}
            ];

            if (items.length === 0) return;

            // Configuration
            // We always use 4 clones to support the desktop view.
            var CLONE_COUNT = 4;
            var totalItems = items.length;
            
            // Generate Clones
            var clonesBefore = items.slice(-CLONE_COUNT);
            var clonesAfter = items.slice(0, CLONE_COUNT);
            var allItems = clonesBefore.concat(items).concat(clonesAfter);
            
            // State
            // Index 0 corresponds to the first REAL item.
            // The track has 'CLONE_COUNT' clones at the start.
            // So the initial offset index is 'CLONE_COUNT'.
            var offsetIndex = CLONE_COUNT; 
            var isAnimating = false;
            
            // Dynamic State
            var currentVisibleItems = 4;
            var itemWidthPercent = 25; // 100 / 4

            // Helper to determine visible items based on width
            function getVisibleItems() {
                return window.innerWidth <= 768 ? 1 : 4;
            }

            // Render all items initially
            allItems.forEach(function(data) {
                var node = createItemNode(data);
                track.appendChild(node);
            });
            
            // Initial Layout
            updateLayout();

            function createItemNode(data) {
                var itemDiv = document.createElement('div');
                itemDiv.className = 'custom-carousel-item';
                
                var imgDiv = document.createElement('div');
                imgDiv.className = 'custom-carousel-img';
                imgDiv.style.backgroundImage = 'url(' + data.image + ')';
                
                var contentDiv = document.createElement('div');
                contentDiv.className = 'custom-carousel-content';
                
                if (data.title) {
                    var title = document.createElement('h3');
                    title.textContent = data.title;
                    contentDiv.appendChild(title);
                }
                
                itemDiv.appendChild(imgDiv);
                itemDiv.appendChild(contentDiv);
                
                return itemDiv;
            }

            function updateLayout() {
                currentVisibleItems = getVisibleItems();
                itemWidthPercent = 100 / currentVisibleItems;
                
                // Update width of all items
                var children = track.children;
                for (var i = 0; i < children.length; i++) {
                    children[i].style.flex = '0 0 ' + itemWidthPercent + '%';
                    children[i].style.width = itemWidthPercent + '%';
                }
                
                // Update position without transition
                updateTransform(false);
            }

            function updateTransform(enableTransition) {
                if (enableTransition) {
                    track.style.transition = 'transform 0.5s ease';
                } else {
                    track.style.transition = 'none';
                }
                
                var percentTranslate = -(offsetIndex * itemWidthPercent);
                track.style.transform = 'translateX(' + percentTranslate + '%)';
            }

            function moveNext() {
                if (isAnimating) return;
                isAnimating = true;
                
                offsetIndex++;
                updateTransform(true);
                
                setTimeout(function() {
                    // Check if we reached the end clones
                    if (offsetIndex >= CLONE_COUNT + totalItems) {
                        // Jump back to start of real items
                        offsetIndex = CLONE_COUNT;
                        updateTransform(false);
                    }
                    isAnimating = false;
                }, 500);
            }

            function movePrev() {
                if (isAnimating) return;
                isAnimating = true;
                
                offsetIndex--;
                updateTransform(true);
                
                setTimeout(function() {
                    // Check if we reached the start clones
                    if (offsetIndex < CLONE_COUNT) {
                        // Jump to end of real items
                        // We are at index CLONE_COUNT - 1 (last item of before-clones)
                        // This corresponds to last real item: (CLONE_COUNT + totalItems - 1)
                        // But wait, if we are at offset CLONE_COUNT - 1, we are technically safely valid?
                        // Yes, but we want to reset to the main list for infinite scroll.
                        
                        // If offsetIndex drops below CLONE_COUNT
                        // It means we are in the left buffer.
                        // We must jump to: offsetIndex + totalItems
                        offsetIndex = offsetIndex + totalItems;
                        updateTransform(false);
                    }
                    isAnimating = false;
                }, 500);
            }

            nextBtn.addEventListener('click', moveNext);
            prevBtn.addEventListener('click', movePrev);
            
            // Resize listener
            var resizeTimeout;
            window.addEventListener('resize', function() {
                clearTimeout(resizeTimeout);
                resizeTimeout = setTimeout(function() {
                    updateLayout();
                }, 100);
            });

        })();
    </script>
{% endblock %}
